<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Development Guidelines</title>
<link rel="stylesheet" type="text/css" href="style.css"/>
</head>
<body>

<h1>avr-llvm Development Guidelines</h1>
<p>
This document contains rules and guideline for the 
<a href="http://avr-llvm.sourceforge.net">avr-llvm</a> developers.
</p>

<h2><a name="reading">Recommended Reading</a></h2>
<p>
  These articles are recommended before hacking on the
  avr-llvm back-end:
</p>
<dl>
  <dt><a href="http://llvm.org/docs/ProgrammersManual.html">LLVM Programmers Manual</a>:</dt>
    <dd>An introduction to some important classes and interfaces</dd>
  <dt><a href="http://llvm.org/docs/CodingStandards.html">LLVM Coding Standards</a></dt>
    <dd></dd>
</dl>

<h2><a name="svn">SVN Repository</a></h2>

<pre>
svn co https://avr-llvm.svn.sourceforge.net/svnroot/avr-llvm/ avr-llvm 
</pre>

<p>avr-llvm svn structure:</p>

<pre>
avr-llvm
|-- cfe
|   `-- trunk
|-- llvm
|   |-- branches
|   |-- tags
|   `-- trunk
|       |-- AVR
|       |-- docs
|       |-- patches
|       |   `-- replace
|       `-- testcases
`-- llvm-gcc-4.2
    `-- trunk
</pre>

<h2><a name="coding">Coding Standards</a></h2>
<p>
  Many rules are covered by the 
  <a href="http://llvm.org/docs/CodingStandards.html">LLVM Coding Standards</a>.
  Some of them are not very restrictive. The following additional rules only 
  affect the avr-llvm back-end. Changes in other source files, e.g. 
  <code>Triple.cpp</code>, should be edited with respect to the 
  <a href="http://llvm.org/docs/CodingStandards.html#GoldenRule">Golden Rule</a>.
</p>

<ol>
  <li>Use two space intention</li>
  <li>Place brackets in the same column
  <p>good:</p>
<pre>
def MEMri : Operand&lt;i8&gt;
{
  let PrintMethod = "printMemOperand";
  let MIOperandInfo = (ops GPRegs, i16imm);
}
</pre>
  <p>not good:</p>
<pre>
def MEMri : Operand&lt;i8&gt; {
  let PrintMethod = "printMemOperand";
  let MIOperandInfo = (ops GPRegs, i16imm);
}
</pre>

  </li>
  <li>Always use brackets
  <p>good:</p>
<pre>
let neverHasSideEffects = 1 in
{
  def NOP : Pseudo&lt;0x00, (outs), (ins), "nop", []&gt;;
}
</pre>
  <p>not good:</p>
<pre>
let neverHasSideEffects = 1 in
  def NOP : Pseudo&lt;0x00, (outs), (ins), "nop", []&gt;;
</pre>
  </li>
  <li>
    If the <a href="http://llvm.org/docs/ProgrammersManual.html#DEBUG"><code>DEBUG()</code></a> macro is used
    <code>#define DEBUG_TYPE "avr"</code> (before <code>#include "lllvm/Support/Debug.h"</code> if possible)
  </li>
</ol>

<h2><a name="commit">Commit Guidelines</a></h2>

<p>
Before changes are committed to the avr-trunk one should insure that the avr 
back-end compiles with the latest llvm trunk. The following instructions are
the recommended procedure which should be performed before every commit:
</p>

<p>
Assuming that your avr-llvm working copy is located in <code>avr-llvm</code>, the llvm 
trunk is <code>llvm</code> and your build directory is <code>build</code>.
</p>

<pre>
$ cd llvm
$ svn update                             # get the latest revision
$ svn revert -R  *                       # revert all changes
$ rm -rf lib/Target/AVR                  # remove AVR Target

$ cat ../avr-llvm/patches/*.diff | patch -p0                  # apply *all* patches 
$ rsync -r --exclude=.svn ../avr-llvm/patches/replace/* ./    # replace *all* autogen files 

$ cp -rf ../avr-llvm/AVR lib/Target/     # cp working copy to llvm src tree
$ cd ../build
$ rm * -rf                               # remove old builds (important!)
  
$ ../llvm/configure --prefix=$HOME/usr/avr-llvm/ --disable-optimized --enable-targets=avr
$ make
</pre>

<p>
If there are errors the changes should not be committed! If the working copy does not 
compile and the changes must be in repository for any reason whatsoever, then we suggest 
creating a branch, commit the changes there and merge them back into trunk as soon as they compile.
Trunk should be compilable all the time. The only reason the trunk can fail should be API 
changes in llvm. 
</p>

<h2>Tips and Tricks</h2>

<h3>Faster development</h3>
<p>
When working on an LLVM back-end a lot of time is spent rebuilding the LLVM tools. 
<code>ccache</code> can increase the build process dramatically (see also: 
<a href="http://wiki.llvm.org/Howto:_Faster_LLVM_development">LLVM Wiki</a> article) 
and it is very easy to use. Just put <code>CXX="ccache g++"</code>  before your <code>
configure</code> command:
</p>

<pre>
$ CXX="ccache g++" ../llvm/configure --prefix=$HOME/usr/avr-llvm/ --disable-optimized --enable-targets=avr
</pre>

<hr/>

<div id="footer">
  <a href="http://validator.w3.org/check?uri=referer"><img
     src="http://www.w3.org/Icons/valid-xhtml10"
     alt="Valid XHTML 1.0 Strict" height="31" width="88" /></a>
  <ul>
    <li><address><a href="http://avr-llvm.sourceforge.net">avr-llvm</a></address></li>
    <li><address>Last modified: $Date$</address></li>
  </ul>
</div>

</body>
</html>
