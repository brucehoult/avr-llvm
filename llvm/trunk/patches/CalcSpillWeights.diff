Index: lib/CodeGen/CalcSpillWeights.cpp
===================================================================
--- lib/CodeGen/CalcSpillWeights.cpp	(revision 183625)
+++ lib/CodeGen/CalcSpillWeights.cpp	(working copy)
@@ -187,7 +187,20 @@
 
   // Mark li as unspillable if all live ranges are tiny.
   if (li.isZeroLength(LIS.getSlotIndexes())) {
-    li.markNotSpillable();
+    // HACK HACK: This is a workaround until PR14879 gets fixed!
+    // This code allows us to compile memory intensive functions when only the Z
+    // register is available, otherwise we get the "Ran out of registers ..."
+    // assertion inside the regalloc.
+    // Here we avoid marking as not spillable live intervals that use the
+    // PTRDISPREGS class and have a size greater than 8, smaller ones
+    // get filtered out, generating better code.
+    if (strcmp(mri.getRegClass(li.reg)->getName(), "PTRDISPREGS") == 0 &&
+        li.getSize() > 8) {
+      totalWeight *= 10000.0F;
+      li.weight = normalizeSpillWeight(totalWeight, li.getSize());
+    } else {
+      li.markNotSpillable();
+    }
     return;
   }
 
