<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<HTML>
<HEAD>
<TITLE>AVR ABI</TITLE>

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">

<LINK REL="STYLESHEET" HREF="abi.css">

</HEAD>

<BODY >

<P>
<H1 ALIGN=CENTER>AVR</H1>
</P>
<HR>

<H2><A NAME="SECTION00010100000000000000">
ABI</A>
</H2>

<P>
The ABI<A NAME="tex2html1"
  HREF="#foot28"><SUP><SPAN CLASS="arabic">1</SPAN></SUP></A> used by avr-gcc is described in 
register usage section of the avr-libc FAQ[<A
 HREF="#avr:faq">1</A>]. In order to ensure
compatibility with the library at least the calling conventions should be 
consistent. The avr-libc declares 17 registers Call-saved (callee-saved) and 
13 registers Call-used (caller-saved). R0 and R1 and fixed purpose register.
R0 may be used as intermediate location for one basic block. R1 is assumed to
be zero. It may be used temporary but must be cleared after use. R1:R0 is 
destination register of all hardware multiplications. R1 must be clear 
manually. The location of the Call-used, Call-saved and Fixed register 
can be seen in figure<A HREF="#fig:registerfile">1</A>. The illustration also shows the
mapping of the 3 possible address registers X, Y, Z. The Y register is used
as frame pointer to indicate the local data on stack.
</P>

<P>

<DIV ALIGN="CENTER"><A NAME="fig:registerfile"></A><A NAME="33"></A>
<TABLE>
<CAPTION ALIGN="BOTTOM"><STRONG>Figure 1:</STRONG>
Register file of an AVR processor</CAPTION>
<TR><TD><DIV ALIGN="CENTER">

</DIV>    <IMG
 ALIGN="BOTTOM" BORDER="0"
 SRC="img1.png"
 ALT="Register file of an AVR processor"></TD></TR>
</TABLE>
</DIV>
</P>

<P>
The function arguments are passed via the registers R25-R8. All values are
aligned to start in an even-numbered register to make better use of <TT>MOVW</TT>
instruction. This means that byte arguments have an empty register above them.
16bit, 32bit and 64bit values are passed in a group of registers (e.g. 
16bit R25:R24, 64bit R25:R18). If there are not enough register, arguments that 
don't fit are passed on the stack without alignment in reversed order. That
means that the very last argument is the first value to be pushed on the stack.
Respectively the first argument that didn't fit into a register is last 
entry on the stack right in front of the return address. 
Figure&nbsp;<A HREF="#fig:framelayout">2</A> illustrates the stack layout during an function 
call. Arguments to functions with variable argument lists are all passed on the 
stack. Byte values are extended to 16bit.
</P>

<P>

<DIV ALIGN="CENTER"><A NAME="fig:framelayout"></A><A NAME="40"></A>
<TABLE>
<CAPTION ALIGN="BOTTOM"><STRONG>Figure 2:</STRONG>
Illustration of the stack layout</CAPTION>
<TR><TD><DIV ALIGN="CENTER">

</DIV>    <IMG
 ALIGN="BOTTOM" BORDER="0"
 SRC="img2.png"
 ALT="Illustration of the stack layout"></TD></TR>
</TABLE>
</DIV>
</P>
<P>
The return value is passed through the register file just like the first
argument. The return type may be up to 64bits wide. 
</P>
<P>
LLVM provides an easy way of defining calling conventions. It is not
limited to one convention but several different versions can be supported.
That makes it possible to use object files created by other compiler with
a different ABI<A NAME="tex2html4"
  HREF="#foot43"><SUP><SPAN CLASS="arabic">2</SPAN></SUP></A>.
</P>
<P>
Leaving every second register empty is not the most convenient way for all
applications. Another calling convention could be defined for smaller AVR 
devices without data RAM.
</P>

<H2><A NAME="SECTION00030000000000000000">
Bibliography</A>
</H2><DL COMPACT><DD><P></P><DT><A NAME="avr:faq">1</A>
<DD>
AVR T<SMALL>OOL </SMALL>C<SMALL>HAIN</SMALL>.
<BR><EM>Frequently Asked Questions</EM>, March 2009.
<BR><TT><A NAME="tex2html5"
  HREF="http://www.nongnu.org/avr-libc/user-manual/FAQ.html">http://www.nongnu.org/avr-libc/user-manual/FAQ.html</A></TT>.
</DL>

<P>
<BR><HR><H4>Footnotes</H4>
<DL>
<DT><A NAME="foot28">... </A><A
 HREF="#tex2html1"><SUP><SPAN CLASS="arabic">1</SPAN></SUP></A></DT>
<DD>Application Binary Interface

</DD>
<DT><A NAME="foot43">... </A><A
 HREF="#tex2html4"><SUP><SPAN CLASS="arabic">2</SPAN></SUP></A></DT>
<DD>e.g older avr-gcc versions used another calling 
convention
</P>
</DD>
</DL>
<ADDRESS>
$Id$
</ADDRESS>
</BODY>
</HTML>
